<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Iranian Sugarscape ABM â€” Mobile (Labeled)</title>
<style>
  :root{
    --bg:#0b0c0f; --ink:#e9e6df; --muted:#9aa0a6; --accent:#1aa7a1; --gold:#c8a552; --rose:#9b3b42;
    --grid:#1d2127; --tile:#0f1217; --beet:#2a7a3a; --cane:#1a6b5c; --port:#2c3d64; --market:#6b3e2e;
    --hud:#12151aee; --panel:#0d1014f2; --ok:#2aa198; --warn:#b58900; --bad:#cb4b16;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans", Ubuntu, Cantarell, "Helvetica Neue", Arial;}
  #app{position:fixed;inset:0;display:flex;flex-direction:column}
  header{position:sticky;top:0;z-index:5;display:flex;gap:.5rem;align-items:center;justify-content:space-between;padding:.5rem .75rem;background:linear-gradient(180deg,#0e1116,#0b0c0f);border-bottom:1px solid #1a1f26}
  .brand{display:flex;align-items:center;gap:.5rem}
  .badge{padding:.15rem .4rem;border:1px solid var(--grid);border-radius:.4rem;background:#0b0e12;color:var(--muted);font-size:.65rem;letter-spacing:.06em}
  .metrics{display:grid;grid-auto-flow:column;gap:.5rem;font-variant-numeric:tabular-nums;white-space:nowrap;overflow:auto;scrollbar-width:thin}
  .k{padding:.2rem .45rem;border-radius:.35rem;background:#0e1217;border:1px solid #1b222b}
  .k b{color:var(--accent)}

  .stage{position:relative;flex:1;display:grid;place-items:center;background:var(--bg);}
  canvas{display:block;max-width:100vw;max-height:100%;touch-action:none;}
  .frame{position:absolute;inset:0;pointer-events:none;border:10px solid transparent;
    background:
      conic-gradient(from 45deg at 10px 10px, var(--gold) 0 20deg, transparent 20deg 90deg,
                     var(--rose) 90deg 110deg, transparent 110deg 180deg,
                     var(--accent) 180deg 200deg, transparent 200deg 270deg,
                     #557 270deg 290deg, transparent 290deg 360deg) padding-box;
    mask: radial-gradient(circle at 50% 50%, transparent 0 70%, black 70% 100%) subtract,
          linear-gradient(#000,#000) content-box;
    opacity:.25
  }

  .legend{position:absolute;right:.5rem;top:.5rem;background:var(--panel);border:1px solid #1b222b;border-radius:.6rem;padding:.4rem .5rem;font-size:.75rem;opacity:.95}
  .legend i{display:inline-block;width:.8rem;height:.8rem;border-radius:.2rem;margin-right:.35rem;vertical-align:-1px}

  .controls{position:sticky;bottom:0;z-index:5;display:flex;flex-wrap:wrap;gap:.5rem;align-items:center;justify-content:center;padding:.5rem .5rem calc(.5rem + env(safe-area-inset-bottom));background:linear-gradient(180deg,#0b0e12,#0a0c10);border-top:1px solid #1a1f26;overflow-x:auto;scrollbar-width:thin}
  .btn{font-size:1.1rem;line-height:1;border:1px solid #1b222b;background:#0e1217;color:var(--ink);border-radius:.6rem;padding:.55rem .7rem}
  .btn:active{transform:translateY(1px)}
  .btn.tog[aria-pressed="true"]{outline:2px solid var(--accent)}
  .sl{appearance:none;width:120px;height:6px;border-radius:6px;background:#141920;outline:none}
  .sl::-webkit-slider-thumb{appearance:none;width:18px;height:18px;border-radius:50%;background:var(--accent);border:1px solid #163e3b}
  select, .num{background:#0e1217;color:var(--ink);border:1px solid #1b222b;border-radius:.5rem;padding:.4rem .5rem}
  .num{width:64px}

  dialog{border:1px solid #1b222b;border-radius:.8rem;background:var(--panel);color:var(--ink);max-width:min(720px,96vw);max-height:85vh;overflow:auto;padding:1rem}
  dialog::backdrop{background:rgba(0,0,0,.5)}
  .modal-title{font-weight:700;margin:.2rem 0 .6rem}
  .row{display:flex;gap:.5rem;flex-wrap:wrap}
  .pill{padding:.2rem .45rem;border-radius:999px;border:1px solid #1b222b;background:#0e1217}
</style>
</head>
<body>
<div id="app">
  <header>
    <div class="brand">
      <div class="badge">Sugarscape â‡„ Iran</div>
      <div class="badge">singleâ€‘file Â· mobile</div>
    </div>
    <div class="metrics" id="metrics">
      <div class="k">Price <b id="mPrice">â€”</b></div>
      <div class="k">Domestic <b id="mDom">â€”</b></div>
      <div class="k">Imports <b id="mImp">â€”</b></div>
      <div class="k">Revenue <b id="mRev">â€”</b></div>
      <div class="k">Gini <b id="mGini">â€”</b></div>
    </div>
  </header>

  <div class="stage">
    <canvas id="cv" aria-label="Iranian Sugarscape"></canvas>
    <div class="frame" aria-hidden="true"></div>
    <div class="legend" id="legend">
      <div><i style="background:var(--cane)"></i>cane</div>
      <div><i style="background:var(--beet)"></i>beet</div>
      <div><i style="background:var(--port)"></i>port</div>
      <div><i style="background:var(--market)"></i>market</div>
      <div><i style="background:#a67"></i>agents</div>
    </div>
  </div>

  <div class="controls">
    <button class="btn" id="play" title="play/pause" aria-pressed="false">â–¶ï¸Ž/â–®â–®</button>
    <button class="btn" id="step" title="step once">â–¸</button>
    <label class="pill">speed <input class="sl" id="speed" type="range" min="0.25" max="3" step="0.25" value="1"></label>
    <button class="btn" id="labels" title="toggle map labels">ðŸ—º</button>
    <select id="era" title="historical scenario">
      <option value="sassanian">460â€“1600 local craft</option>
      <option value="imports">1600â€“1930 import era</option>
      <option value="monopoly">1927â€“1932 monopoly</option>
      <option value="industrial">1933â€“1979 industrial</option>
      <option value="modern" selected>1980â€“2025 modern</option>
    </select>
    <button class="btn" id="pol" title="policy & constraints">âš–</button>
    <button class="btn" id="rst" title="restart">âŸ²</button>
  </div>
</div>

<dialog id="dlg">
  <div class="modal-title">Policy & Negative Constraints</div>
  <div class="row" style="margin-bottom:.6rem">
    <label class="pill">tariff % <input class="num" id="tariff" type="number" min="0" max="80" step="1" value="15"></label>
    <label class="pill">subsidy % <input class="num" id="subsidy" type="number" min="0" max="80" step="1" value="10"></label>
    <label class="pill">sanctions <input id="sanctions" type="checkbox"></label>
    <label class="pill">climate shock <input id="climate" type="checkbox"></label>
  </div>
  <small>
    <b>Negative constraints (programmatic guards):</b>
    <ul>
      <li>No plantation slavery mechanics (nonâ€‘applicable in Iran). Farmers are free agents only.</li>
      <li>Crop ecology is regional: cane is limited to Khuzestan belt; beet to highâ€‘plateau zones. No global homogenization.</li>
      <li>Eraâ€‘appropriate technology: no beet industry before lateâ€‘Qajar/earlyâ€‘Pahlavi; import channels disabled in early era.</li>
      <li>Prices emerge endogenously from supplyâ†”demand plus policy; no arbitrary global equalization.</li>
    </ul>
  </small>
  <form method="dialog" style="margin-top:.5rem;text-align:right">
    <button class="btn">Close</button>
  </form>
</dialog>

<script>
(() => {
  const W = 36, H = 24;               // grid size (mobile-friendly)
  const TILE = 18;                     // logical pixel size (scaled to DPR)
  const AGENTS = 200;                  // total mobile agents
  const DPR = Math.max(1, Math.min(2, window.devicePixelRatio||1));

  const kinds = { EMPTY:0, DESERT:0, BEET:1, CANE:2, PORT:3, MARKET:4 };

  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d');
  function resize() {
    const vw = Math.min(window.innerWidth, 720);
    const vh = window.innerHeight - 148; // header+controls approx
    const scale = Math.min(vw/(W*TILE), vh/(H*TILE));
    cv.style.width = (W*TILE*scale)+"px";
    cv.style.height = (H*TILE*scale)+"px";
    cv.width = Math.floor(W*TILE*scale*DPR);
    cv.height = Math.floor(H*TILE*scale*DPR);
    ctx.setTransform((cv.width/W)/TILE,0,0,(cv.height/H)/TILE,0,0);
  }
  window.addEventListener('resize', resize, {passive:true});

  let world, sugar, cap, growth, ports=[], markets=[], caneCells=[], beetCells=[], labels=[];
  let agents=[], traders=[], farmers=[]; let labelsOn=true;
  let tick=0, running=false, speed=1;
  let params = { era:'modern', tariff:0.15, subsidy:0.10, sanctions:false, climate:false };

  const ERA = {
    sassanian: { imports:0.0, traders:20, farmers:140, beetAllowed:false, caneAllowed:true, basePrice:1.0 },
    imports:   { imports:0.6, traders:70, farmers:100, beetAllowed:true, caneAllowed:true, basePrice:0.9 },
    monopoly:  { imports:0.5, traders:45, farmers:110, beetAllowed:true, caneAllowed:true, basePrice:1.1, monopoly:true },
    industrial:{ imports:0.25,traders:50, farmers:120, beetAllowed:true, caneAllowed:true, basePrice:0.95, refineryBoost:true },
    modern:    { imports:0.35,traders:60, farmers:120, beetAllowed:true, caneAllowed:true, basePrice:1.05, volatility:true }
  };

  function rand(n){return Math.random()*n}
  function randi(n){return (Math.random()*n)|0}
  function clamp(x,a,b){return x<a?a:x>b?b:x}
  function inBounds(x,y){return x>=0&&y>=0&&x<W&&y<H}
  function idx(x,y){return y*W+x}

  function seedRegions(){
    world = new Uint8Array(W*H);
    sugar = new Float32Array(W*H);
    cap   = new Float32Array(W*H);
    growth= new Float32Array(W*H);
    ports.length=0; markets.length=0; caneCells.length=0; beetCells.length=0; labels.length=0;

    // Base terrain
    for(let y=0;y<H;y++) for(let x=0;x<W;x++){
      world[idx(x,y)] = kinds.DESERT; sugar[idx(x,y)] = 1+rand(2); cap[idx(x,y)] = 5+rand(6); growth[idx(x,y)] = 0.03+rand(0.04);
    }
    // Khuzestan cane belt
    for(let y=12;y<21;y++) for(let x=2;x<12;x++){
      world[idx(x,y)] = kinds.CANE; cap[idx(x,y)] = 40+rand(12); growth[idx(x,y)] = 0.55+rand(0.35); caneCells.push([x,y]);
    }
    // NW & Central beet belt
    for(let y=4;y<12;y++) for(let x=20;x<34;x++){
      world[idx(x,y)] = kinds.BEET; cap[idx(x,y)] = 22+rand(10); growth[idx(x,y)] = 0.32+rand(0.22); beetCells.push([x,y]);
    }
    for(let y=11;y<16;y++) for(let x=16;x<22;x++){
      world[idx(x,y)] = kinds.BEET; cap[idx(x,y)] = 20+rand(8); growth[idx(x,y)] = 0.28+rand(0.18); beetCells.push([x,y]);
    }

    // Ports: Bandar Abbas, Bushehr, Anzali, Abadan
    const P=[[6,22,'Bandar Abbas'],[3,18,'Bushehr'],[28,2,'Anzali'],[5,20,'Abadan']];
    for(const [x,y,name] of P){ world[idx(x,y)] = kinds.PORT; ports.push([x,y]); cap[idx(x,y)]=55; growth[idx(x,y)]=0.05; labels.push({x,y,text:name,type:'port'}); }

    // Markets (urban demand & redistribution)
    const M=[[18,10,'Tehran'],[22,13,'Isfahan'],[30,6,'Tabriz'],[14,17,'Shiraz'],[33,8,'Mashhad'],[8,16,'Ahvaz']];
    for(const [x,y,name] of M){ world[idx(x,y)] = kinds.MARKET; markets.push([x,y]); cap[idx(x,y)]=65; growth[idx(x,y)]=0.05; labels.push({x,y,text:name,type:'market'}); }

    // Refineries / anchors (labels only)
    labels.push({x:7,y:17,text:'Haftâ€‘Tappeh',type:'refinery'});
    labels.push({x:16,y:11,text:'Kermanshah (beet)',type:'refinery'});

    // Regions
    labels.push({x:24,y:9,text:'Azerbaijanâ€“Zanjan Beet Belt',type:'region'});
    labels.push({x:6,y:14,text:'Khuzestan Cane Belt',type:'region'});

    for(let i=0;i<W*H;i++) sugar[i] = Math.min(cap[i], sugar[i]+cap[i]*0.35);
  }

  function spawnAgents(){
    agents.length=0; traders.length=0; farmers.length=0;
    const e = ERA[params.era];
    function spawnFarmers(n, cells){
      for(let i=0;i<n;i++){
        const [x,y]=cells[randi(cells.length)];
        const a={type:'farmer', x, y, vx:0, vy:0, sugar:0, vision:2+randi(3), metabolism: 0.5+rand(0.6), wealth: 2+rand(4)};
        farmers.push(a); agents.push(a);
      }
    }
    const fCane = Math.round(e.farmers * 0.55);
    const fBeet = e.beetAllowed? Math.max(5, e.farmers - fCane) : 0;
    if(e.caneAllowed) spawnFarmers(fCane, caneCells);
    if(e.beetAllowed) spawnFarmers(fBeet, beetCells);

    for(let i=0;i<e.traders;i++){
      const src = (i%2===0? ports:markets)[randi((i%2===0?ports:markets).length)];
      const [x,y]=src; const t={type:'trader', x, y, vx:0, vy:0, sugar:0, capacity: 12+rand(18), wealth:4+rand(10)};
      traders.push(t); agents.push(t);
    }
  }

  function closest(list, x, y){ let best=null, bd=1e9; for(const [lx,ly] of list){ const d=Math.abs(lx-x)+Math.abs(ly-y); if(d<bd){bd=d; best=[lx,ly];} } return best; }

  const econ = { price:1.0, demand:80, supply:0, imports:0, domestic:0, revenue:0, lastSupply:0, lastDemand:80, lorenzSamples:[] };
  function resetEcon(){ const e=ERA[params.era]; econ.price=e.basePrice; econ.demand=90; econ.supply=0; econ.imports=0; econ.domestic=0; econ.revenue=0; econ.lorenzSamples.length=0; }

  function updatePrice(){
    const e = ERA[params.era];
    const shortage = (econ.lastDemand+1) / (econ.lastSupply+1);
    let k = 0.12 * (params.sanctions?1.8:1.0) * (e.volatility?1.4:1.0);
    if(e.monopoly) k *= 0.7; 
    const target = clamp(e.basePrice * Math.pow(shortage, k*8), 0.4, 6);
    econ.price = econ.price*0.8 + target*0.2;
  }

  function importFlow(){
    const e = ERA[params.era];
    let base = e.imports * 40;
    if(params.sanctions) base *= 0.45;           
    const tariff = params.tariff;                
    const afterTariff = base * (1 - tariff*0.6);
    const amt = Math.max(0, afterTariff + (Math.random()-0.5)* (e.volatility?10:4));
    let per = amt / Math.max(1, ports.length);
    for(const [x,y] of ports){ sugar[idx(x,y)] = Math.min(cap[idx(x,y)], sugar[idx(x,y)] + per); }
    econ.imports += amt;
    econ.revenue += amt * tariff * econ.price * 0.2; 
  }

  function climateShock(){
    if(!params.climate) return;
    const hit = Math.random()<0.5? caneCells: beetCells;
    for(const [x,y] of hit){ growth[idx(x,y)] *= 0.95; }
  }

  function stepToward(a, tx, ty){ const dx = Math.sign(tx - a.x); const dy = Math.sign(ty - a.y); if(Math.abs(tx-a.x)>Math.abs(ty-a.y)) a.x += dx; else a.y += dy; a.x=clamp(a.x,0,W-1); a.y=clamp(a.y,0,H-1); }

  function tickWorld(){
    tick++;
    const e = ERA[params.era];

    for(let i=0;i<W*H;i++) sugar[i] = Math.min(cap[i], sugar[i] + growth[i]);
    if(e.refineryBoost){ for(const [x,y] of caneCells){ growth[idx(x,y)] = Math.min(growth[idx(x,y)]*1.0015, 1.0); } for(const [x,y] of beetCells){ growth[idx(x,y)] = Math.min(growth[idx(x,y)]*1.001, 0.7); } }

    if(e.imports>0) importFlow();
    climateShock();

    let domestic=0;
    for(const a of farmers){
      const here = world[idx(a.x,a.y)];
      if(here!==kinds.CANE && here!==kinds.BEET){
        const tgt = (Math.random()<0.5 && caneCells.length? closest(caneCells,a.x,a.y): closest(beetCells,a.x,a.y));
        stepToward(a, tgt[0], tgt[1]);
      } else {
        const i = idx(a.x,a.y);
        const take = Math.min(sugar[i], 0.8 + rand(0.8));
        sugar[i]-=take; a.sugar += take; a.wealth -= a.metabolism*0.05;
        if(a.sugar>3){
          const [mx,my] = closest(markets,a.x,a.y);
          stepToward(a, mx, my);
          if(a.x===mx && a.y===my){
            const paid = a.sugar * econ.price * (1 + params.subsidy*0.3);
            a.wealth += paid; domestic += a.sugar; a.sugar=0;
            sugar[idx(mx,my)] = Math.min(cap[idx(mx,my)], sugar[idx(mx,my)] + 0.5);
          }
        } else {
          a.x = clamp(a.x + (randi(3)-1), 0, W-1); a.y = clamp(a.y + (randi(3)-1), 0, H-1);
        }
      }
    }

    for(const t of traders){
      if(t.sugar < t.capacity*0.25){
        const [px,py]=closest(ports,t.x,t.y); stepToward(t,px,py);
        if(t.x===px && t.y===py){ const i=idx(px,py); const load = Math.min(sugar[i], t.capacity - t.sugar); sugar[i]-=load; t.sugar+=load; econ.revenue += load * params.tariff * econ.price * 0.1; }
      } else {
        let best=markets[0], bestStock=1e9; for(const [mx,my] of markets){ const s=sugar[idx(mx,my)]; if(s<bestStock){bestStock=s; best=[mx,my];} }
        stepToward(t,best[0],best[1]);
        if(t.x===best[0] && t.y===best[1]){ const i=idx(t.x,t.y); sugar[i]+=t.sugar; t.wealth += t.sugar * econ.price * (1-params.tariff*0.2); t.sugar=0; }
      }
    }

    let demand=0, supply=0;
    for(const [mx,my] of markets){ const i=idx(mx,my); const need = 18 + rand(10); demand += need; const take = Math.min(need, sugar[i]); sugar[i]-=take; supply += take; }

    econ.domestic += domestic; econ.lastSupply = supply; econ.lastDemand = demand; econ.supply += supply; updatePrice();

    if((tick%4)===0){ for(let j=0;j<10;j++){ const a=agents[randi(agents.length)]; econ.lorenzSamples.push(a.wealth); } if(econ.lorenzSamples.length>500) econ.lorenzSamples.splice(0, econ.lorenzSamples.length-500); }
  }

  function gini(arr){ if(arr.length<2) return 0; const s=[...arr].sort((a,b)=>a-b); const n=s.length; let cum=0,sum=0; for(let i=0;i<n;i++){ cum+=s[i]; sum+=cum; } const fair=(n+1)/2 * s.reduce((a,b)=>a+b,0); return clamp(((n+1) - 2*sum/cum),0,1); }

  function draw(){
    ctx.fillStyle = '#0c0f14'; ctx.fillRect(0,0,W*TILE,H*TILE);
    for(let y=0;y<H;y++){
      for(let x=0;x<W;x++){
        const k = world[idx(x,y)];
        ctx.fillStyle = k===kinds.CANE? getCSS('--cane') : k===kinds.BEET? getCSS('--beet') : k===kinds.PORT? getCSS('--port') : k===kinds.MARKET? getCSS('--market') : getCSS('--tile');
        ctx.fillRect(x*TILE,y*TILE,TILE,TILE);
        ctx.globalAlpha = 0.16; ctx.strokeStyle = '#cdb67a';
        ctx.beginPath(); const cx=x*TILE+TILE/2, cy=y*TILE+TILE/2, r=TILE*0.38;
        ctx.moveTo(cx-r,cy); ctx.lineTo(cx,cy-r); ctx.lineTo(cx+r,cy); ctx.lineTo(cx,cy+r); ctx.closePath(); ctx.stroke(); ctx.globalAlpha = 1;
        const s = sugar[idx(x,y)]/Math.max(1,cap[idx(x,y)]);
        if(s>0){ ctx.fillStyle = `rgba(200,165,82,${0.04+s*0.22})`; ctx.fillRect(x*TILE,y*TILE,TILE,TILE); }
      }
    }

    // corridors (portsâ†’Tehran/Isfahan)
    ctx.globalAlpha=0.25; ctx.strokeStyle='#88a'; ctx.lineWidth=1.5;
    function line(ax,ay,bx,by){ ctx.beginPath(); ctx.moveTo(ax*TILE+TILE/2,ay*TILE+TILE/2); ctx.lineTo(bx*TILE+TILE/2,by*TILE+TILE/2); ctx.stroke(); }
    const t=markets.find(m=>m[0]===18&&m[1]===10)||markets[0];
    const i=markets.find(m=>m[0]===22&&m[1]===13)||markets[0];
    for(const [px,py] of ports){ line(px,py,t[0],t[1]); line(px,py,i[0],i[1]); }
    ctx.globalAlpha=1;

    // agents
    ctx.fillStyle = '#d48aa8';
    for(const a of agents){ ctx.fillRect(a.x*TILE+TILE*0.35, a.y*TILE+TILE*0.35, TILE*0.3, TILE*0.3); }

    if(labelsOn){ drawLabels(); }

    ctx.fillStyle = getCSS('--muted'); ctx.font = `${TILE*0.6}px ui-sans-serif`; ctx.fillText(`t${tick}`, 4, TILE*0.9);
  }

  function drawLabels(){
    const f = `${Math.max(10, TILE*0.6)}px ui-sans-serif`;
    ctx.font = f; ctx.textBaseline='middle'; ctx.textAlign='left';
    for(const L of labels){
      let color = '#cfc7a5'; if(L.type==='port') color='#9fb7ff'; else if(L.type==='market') color='#ffb28a'; else if(L.type==='refinery') color='#8be0c6'; else if(L.type==='region') color='#e3d08a';
      ctx.fillStyle = 'rgba(0,0,0,0.45)'; const w = ctx.measureText(L.text).width+8; ctx.fillRect(L.x*TILE+2, L.y*TILE-8, w, 16);
      ctx.fillStyle = color; ctx.fillText(L.text, L.x*TILE+6, L.y*TILE);
    }
  }

  function getCSS(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }

  const mPrice=document.getElementById('mPrice');
  const mDom=document.getElementById('mDom');
  const mImp=document.getElementById('mImp');
  const mRev=document.getElementById('mRev');
  const mGini=document.getElementById('mGini');
  function hud(){ mPrice.textContent = econ.price.toFixed(2); mDom.textContent = Math.round(econ.domestic); mImp.textContent = Math.round(econ.imports); mRev.textContent = Math.round(econ.revenue); mGini.textContent = gini(econ.lorenzSamples).toFixed(2); }

  let raf=null, last=0;
  function loop(ts){ if(!running){ raf=requestAnimationFrame(loop); return; } const stepMs = 200 / speed; if(ts-last>stepMs){ tickWorld(); draw(); hud(); last=ts; } raf=requestAnimationFrame(loop); }

  const playBtn = document.getElementById('play');
  const stepBtn = document.getElementById('step');
  const rstBtn  = document.getElementById('rst');
  const speedEl = document.getElementById('speed');
  const eraSel  = document.getElementById('era');
  const polBtn  = document.getElementById('pol');
  const dlg     = document.getElementById('dlg');
  const tariffEl= document.getElementById('tariff');
  const subsidyEl=document.getElementById('subsidy');
  const sanctionsEl=document.getElementById('sanctions');
  const climateEl=document.getElementById('climate');
  const labelsBtn=document.getElementById('labels');

  playBtn.addEventListener('click', ()=>{ running=!running; playBtn.setAttribute('aria-pressed', String(running)); });
  stepBtn.addEventListener('click', ()=>{ tickWorld(); draw(); hud(); });
  rstBtn.addEventListener('click', ()=>{ init(); });
  speedEl.addEventListener('input', ()=>{ speed = parseFloat(speedEl.value); });
  eraSel.addEventListener('change', ()=>{ params.era=eraSel.value; init(false); });
  polBtn.addEventListener('click', ()=>{ dlg.showModal(); });
  tariffEl.addEventListener('input', ()=>{ params.tariff = clamp(parseFloat(tariffEl.value)/100,0,0.8); });
  subsidyEl.addEventListener('input', ()=>{ params.subsidy = clamp(parseFloat(subsidyEl.value)/100,0,0.8); });
  sanctionsEl.addEventListener('change', ()=>{ params.sanctions = sanctionsEl.checked; });
  climateEl.addEventListener('change',   ()=>{ params.climate   = climateEl.checked; });
  labelsBtn.addEventListener('click', ()=>{ labelsOn=!labelsOn; draw(); });

  function init(resetPolicy=true){
    tick=0; if(resetPolicy){ params={ era: eraSel.value, tariff:0.15, subsidy:0.10, sanctions:false, climate:false };
      tariffEl.value=15; subsidyEl.value=10; sanctionsEl.checked=false; climateEl.checked=false; }
    seedRegions(); spawnAgents(); resetEcon(); resize(); draw(); hud();
  }

  init(); running=true; requestAnimationFrame(loop);
})();
</script>
</body>
</html>
